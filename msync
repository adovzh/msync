#!/bin/bash

PRETEND=
DELETE_FLAGS=
RESTORE=

ARGS=$(getopt -o pdr --long pretend,delete,restore -n msync -- "$@")

if [ $? != 0 ] ; then
  echo "Terminating..." >&2
  exit 1
fi

eval set -- "$ARGS"

while true; do
  case "$1" in
    -p | --pretend )
      PRETEND=YES
      ;;
    -d | --delete )
      DELETE_FLAGS=" --delete --delete-excluded"
      ;;
    -r | --restore)
      RESTORE=YES
      ;;
    --)
      shift
      break
      ;;
    *)
      break ;;
  esac

  shift
done

# msync what?
# set SRC and TGT variables
case $1 in
  music)
    echo "Syncing music"
    SRC=/var/media/music
    TGT="sshd@10.1.1.11:/shares/Public/Shared Music"
    ;;
  video)
    echo "Syncing video"
    SRC=/var/media/video
    TGT="sshd@10.1.1.11:/shares/Public/Shared Videos"
    ;;
  *)
    echo "Unknown source: $1"
    exit -1
    ;;
esac

if [ -z "$RESTORE" ] ; then
  MSSRC="$SRC/"
  MSTGT="$TGT"
else
  MSSRC="$TGT/"
  MSTGT="$SRC"
fi

MSARGS="azPvs"

[ ! -z "$PRETEND" ] && MSARGS="${MSARGS}n"

echo "======================"
echo "Sync source: $MSSRC"
echo "Sync target: \"$MSTGT\""
echo "Arguments: \"$MSARGS\""

CMD="rsync -${MSARGS}${DELETE_FLAGS} --exclude '*.DS_Store' $MSSRC \"$MSTGT\""

echo "Issuing command: '$CMD'"
echo "======================"

rsync -$MSARGS${DELETE_FLAGS} --exclude '*.DS_Store' "$MSSRC" "$MSTGT"
